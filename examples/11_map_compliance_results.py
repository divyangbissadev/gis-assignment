import folium
import sys
from typing import Dict, Any, List

from src.arcgis_client import ArcGISClient
from src.compliance_checker import analyze_oil_gas_lease_compliance
from src.logger import get_logger
from src.errors import ArcGISError, ComplianceError

logger = get_logger(__name__)

def create_compliance_map(report: Dict[str, Any], output_html_path: str = "compliance_map.html") -> None:
    """
    Generates an HTML map visualizing compliant and non-compliant counties.

    Args:
        report: The compliance report generated by analyze_oil_gas_lease_compliance,
                with include_geojson=True.
        output_html_path: The path to save the generated HTML map file.
    """
    logger.info(f"Creating compliance map: {output_html_path}")

    # Initialize a Folium map centered roughly on Texas
    m = folium.Map(location=[31.9686, -99.9018], zoom_start=6)

    # Add compliant counties as green polygons
    for county in report.get("compliant_counties", []):
        if "geometry" in county and county["geometry"]:
            folium.GeoJson(
                county["geometry"],
                name=f"Compliant: {county['county_name']}",
                style_function=lambda x: {"fillColor": "green", "color": "black", "weight": 1, "fillOpacity": 0.5},
                tooltip=folium.Tooltip(
                    f"County: {county['county_name']}<br>"
                    f"State: {county['state']}<br>"
                    f"Area: {county['area_sq_miles']:.2f} sq mi<br>"
                    f"Required: {county['required_sq_miles']:.2f} sq mi<br>"
                    f"Status: Compliant"
                )
            ).add_to(m)

    # Add non-compliant counties as red polygons
    for county in report.get("non_compliant_counties", []):
        if "geometry" in county and county["geometry"]:
            folium.GeoJson(
                county["geometry"],
                name=f"Non-Compliant: {county['county_name']}",
                style_function=lambda x: {"fillColor": "red", "color": "black", "weight": 1, "fillOpacity": 0.5},
                tooltip=folium.Tooltip(
                    f"County: {county['county_name']}<br>"
                    f"State: {county['state']}<br>"
                    f"Area: {county['area_sq_miles']:.2f} sq mi<br>"
                    f"Required: {county['required_sq_miles']:.2f} sq mi<br>"
                    f"Shortfall: {county['shortfall_sq_miles']:.2f} sq mi<br>"
                    f"Compliance: {county['compliance_percentage']:.2f}%<br>"
                    f"Recommendation: {county['recommendation']}"
                )
            ).add_to(m)
    
    # Add a layer control to toggle compliant/non-compliant layers
    folium.LayerControl().add_to(m)

    m.save(output_html_path)
    logger.info(f"Map saved to {output_html_path}")
    print(f"\n✓ Map saved to: {output_html_path}")


def main() -> int:
    """
    Main entry point for generating the compliance map.
    """
    print("\n" + "=" * 80)
    print("  Generating Oil & Gas Lease Compliance Map - Texas Counties")
    print("=" * 80 + "\n")

    service_url = (
        "https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/"
        "USA_Census_Counties/FeatureServer/0"
    )
    min_area = 2500.0

    logger.info("Starting map generation for Texas counties analysis")

    try:
        with ArcGISClient(service_url) as client:
            print("Querying Texas counties from ArcGIS Feature Service with GeoJSON...")
            texas_counties_features = client.query(
                where="STATE_NAME = 'Texas'",
                page_size=500,
                paginate=True
            )
            print(f"✓ Retrieved {len(texas_counties_features.get('features', []))} Texas counties.")

            print(f"Analyzing compliance with minimum area of {min_area} sq miles...")
            compliance_report = analyze_oil_gas_lease_compliance(
                texas_counties_features['features'],
                min_area_sq_miles=min_area,
                include_geojson=True  # Crucial for map visualization
            )

            create_compliance_map(compliance_report, "texas_compliance_map.html")
            logger.info("Map generation completed successfully.")
            return 0

    except ArcGISError as e:
        logger.error(f"ArcGIS query failed: {e}", exc_info=True)
        print(f"\n✗ Error querying ArcGIS service: {e}")
        return 1
    except ComplianceError as e:
        logger.error(f"Compliance analysis failed: {e}", exc_info=True)
        print(f"\n✗ Error analyzing compliance: {e}")
        return 1
    except Exception as e:
        logger.critical(f"An unexpected error occurred: {e}", exc_info=True)
        print(f"\n✗ An unexpected error occurred: {e}")
        return 1

if __name__ == "__main__":
    sys.exit(main())
