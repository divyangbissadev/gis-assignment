"""
Example 11: Map Compliance Results

This example demonstrates how to visualize compliance analysis results
on an interactive map using Folium.

Run:
    python examples/11_map_compliance_results.py
    python examples/11_map_compliance_results.py --state=California
    python examples/11_map_compliance_results.py --state=Texas --min-area=3000.0
    python examples/11_map_compliance_results.py --output=my_map.html
"""

import folium
import sys
import os
import argparse
from typing import Dict, Any, List
from dotenv import load_dotenv

load_dotenv()

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.arcgis_client import ArcGISClient
from src.compliance_checker import analyze_oil_gas_lease_compliance
from src.logger import get_logger
from src.errors import ArcGISError, ComplianceError

logger = get_logger(__name__)

def parse_arguments():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description='Generate interactive compliance map visualization'
    )
    parser.add_argument(
        '--state',
        type=str,
        default='Texas',
        help='State to analyze (default: Texas)'
    )
    parser.add_argument(
        '--min-area',
        type=float,
        default=2500.0,
        help='Minimum area requirement in square miles (default: 2500.0)'
    )
    parser.add_argument(
        '--output',
        type=str,
        default='compliance_map.html',
        help='Output HTML file path (default: compliance_map.html)'
    )
    return parser.parse_args()


# State center coordinates for map initialization
STATE_CENTERS = {
    'Texas': (31.9686, -99.9018),
    'California': (36.7783, -119.4179),
    'Oklahoma': (35.0078, -97.0929),
    'Louisiana': (30.9843, -91.9623),
    'New Mexico': (34.5199, -105.8701),
    'Wyoming': (43.0760, -107.2903),
    'Colorado': (39.5501, -105.7821),
    'North Dakota': (47.5515, -101.0020),
    'Montana': (46.8797, -110.3626),
    'Kansas': (39.0119, -98.4842),
}


def create_compliance_map(report: Dict[str, Any], state: str, output_html_path: str = "compliance_map.html") -> None:
    """
    Generates an HTML map visualizing compliant and non-compliant counties.

    Args:
        report: The compliance report generated by analyze_oil_gas_lease_compliance,
                with include_geojson=True.
        state: The state being analyzed (for map centering).
        output_html_path: The path to save the generated HTML map file.
    """
    logger.info(f"Creating compliance map: {output_html_path}")

    # Get center coordinates for the state, default to US center if not found
    center = STATE_CENTERS.get(state, (39.8283, -98.5795))

    # Initialize a Folium map centered on the state
    m = folium.Map(location=center, zoom_start=6)

    # Add compliant counties as green polygons
    for county in report.get("compliant_counties", []):
        if "geometry" in county and county["geometry"]:
            folium.GeoJson(
                county["geometry"],
                name=f"Compliant: {county['county_name']}",
                style_function=lambda x: {"fillColor": "green", "color": "black", "weight": 1, "fillOpacity": 0.5},
                tooltip=folium.Tooltip(
                    f"County: {county['county_name']}<br>"
                    f"State: {county['state']}<br>"
                    f"Area: {county['area_sq_miles']:.2f} sq mi<br>"
                    f"Required: {county['required_sq_miles']:.2f} sq mi<br>"
                    f"Status: Compliant"
                )
            ).add_to(m)

    # Add non-compliant counties as red polygons
    for county in report.get("non_compliant_counties", []):
        if "geometry" in county and county["geometry"]:
            folium.GeoJson(
                county["geometry"],
                name=f"Non-Compliant: {county['county_name']}",
                style_function=lambda x: {"fillColor": "red", "color": "black", "weight": 1, "fillOpacity": 0.5},
                tooltip=folium.Tooltip(
                    f"County: {county['county_name']}<br>"
                    f"State: {county['state']}<br>"
                    f"Area: {county['area_sq_miles']:.2f} sq mi<br>"
                    f"Required: {county['required_sq_miles']:.2f} sq mi<br>"
                    f"Shortfall: {county['shortfall_sq_miles']:.2f} sq mi<br>"
                    f"Compliance: {county['compliance_percentage']:.2f}%<br>"
                    f"Recommendation: {county['recommendation']}"
                )
            ).add_to(m)
    
    # Add a layer control to toggle compliant/non-compliant layers
    folium.LayerControl().add_to(m)

    m.save(output_html_path)
    logger.info(f"Map saved to {output_html_path}")
    print(f"\n✓ Map saved to: {output_html_path}")


def main() -> int:
    """
    Main entry point for generating the compliance map.
    """
    args = parse_arguments()

    print("\n" + "=" * 80)
    print(f"  Generating Oil & Gas Lease Compliance Map - {args.state} Counties")
    print("=" * 80)
    print(f"State: {args.state}")
    print(f"Minimum Area: {args.min_area} sq mi")
    print(f"Output: {args.output}\n")

    service_url = os.getenv(
        'ARCGIS_SERVICE_URL',
        "https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/"
        "USA_Census_Counties/FeatureServer/0"
    )

    logger.info(f"Starting map generation for {args.state} counties analysis")

    try:
        with ArcGISClient(service_url) as client:
            print(f"Querying {args.state} counties from ArcGIS Feature Service with GeoJSON...")
            state_counties_features = client.query(
                where=f"STATE_NAME = '{args.state}'",
                page_size=500,
                paginate=True
            )
            print(f"✓ Retrieved {len(state_counties_features.get('features', []))} {args.state} counties.")

            print(f"Analyzing compliance with minimum area of {args.min_area} sq miles...")
            compliance_report = analyze_oil_gas_lease_compliance(
                state_counties_features['features'],
                min_area_sq_miles=args.min_area,
                include_geojson=True  # Crucial for map visualization
            )

            create_compliance_map(compliance_report, args.state, args.output)
            logger.info("Map generation completed successfully.")
            return 0

    except ArcGISError as e:
        logger.error(f"ArcGIS query failed: {e}", exc_info=True)
        print(f"\n✗ Error querying ArcGIS service: {e}")
        return 1
    except ComplianceError as e:
        logger.error(f"Compliance analysis failed: {e}", exc_info=True)
        print(f"\n✗ Error analyzing compliance: {e}")
        return 1
    except Exception as e:
        logger.critical(f"An unexpected error occurred: {e}", exc_info=True)
        print(f"\n✗ An unexpected error occurred: {e}")
        return 1

if __name__ == "__main__":
    sys.exit(main())
